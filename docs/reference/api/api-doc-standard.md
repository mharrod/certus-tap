# API Documentation Standard

## Purpose
Define the uniform structure that every Certus TAP endpoint must follow so API docs remain predictable, traceable, and easy to consume by internal and external clients.

## Audience & Prerequisites
- Backend engineers and contributors writing or reviewing FastAPI endpoints.
- Technical writers updating API references.
- Familiarity with FastAPI docstrings plus the [Standard Response Format](api-response.md) and [API Error Codes](api-error-codes.md).

## Overview
- All endpoint docstrings share a consistent order and content set.
- Each docstring captures request/response examples, authentication, success/error payloads, and argument/exception details.
- Optional sections document business logic notes, rate limiting, or batch semantics when applicable.
- Rich examples ensure autogenerated docs (OpenAPI, MkDocs, Streamlit console) stay synchronized.

## Key Concepts

### Docstring Structure
Every endpoint docstring MUST follow this skeleton:

```python
@router.post(
    "/endpoint-path",
    response_model=ResponseModel,
    responses={...},
)
async def endpoint_function(param1: Type1, param2: Type2) -> ResponseModel:
    """
    One-liner summary of what the endpoint does.

    Longer description explaining the functionality, business logic,
    and any important considerations.

    **Request Example:**
    [curl command]

    **Success Response (200/201):**
    [JSON response example]

    **Error Response (400):**
    [JSON response example]

    Args:
        param1: Description
        param2: Description

    Returns:
        ResponseModel summary

    Raises:
        HTTPException 400: ...
            - Error code: `code_name` - Explanation
        HTTPException 404: ...
    """
```

### Required Sections

#### 1. One-Liner Summary
- Single sentence fragment beginning with a verb (“Upload…”, “List…”).
- Under 80 characters; no trailing period.

✅ `Upload and index a single document`
❌ `Document upload endpoint`

#### 2. Detailed Description
- Two or three sentences explaining behavior, constraints, or side effects (PII quarantine, logging, limits).
- Omit implementation internals.

#### 3. Request Example
- Provide a runnable `curl` snippet with correct method, URL, headers (`Content-Type`, `Authorization` if required), body (`-d` JSON or `-F` multipart).
- Use `\` line continuations for readability.

#### 4. Authentication & Headers
- Immediately under the request example, enumerate required headers and schemes.
- Mention optional trace overrides (e.g., `X-Trace-ID`) or tenancy headers.

#### 5. Success Response(s)
- Label each block `**Success Response (HTTP_CODE):**`.
- Include complete JSON showing all required fields.
- Typical codes: `200 OK`, `201 Created`.

#### 6. Error Responses
- Provide JSON for every possible HTTP code (400/401/403/404/409/422/429/500/503/504 as applicable).
- Include `error`, `message`, and `detail/context` fields that mirror actual responses.
- Reference canonical codes from [API Error Codes](api-error-codes.md).

### Optional Sections
- **Business Logic Notes** – highlight non-obvious behavior (PII quarantine, anonymization).
- **Rate Limiting** – specify quotas and 429 behavior.
- **Batch Operation Notes** – describe partial failures, retry lists, or ordering.

Example:

```markdown
**Rate Limiting:** 100 requests per minute per API key. Returns 429 when exceeded.
```

### Code Examples
Use full docstring samples to illustrate expectations.

#### Example: GET Endpoint
````python
@router.get(
    "/list/{bucket_name}",
    response_model=ListResponse,
    responses={
        404: {"model": NotFoundErrorResponse, "description": "Bucket does not exist"},
        500: {"model": InternalServerErrorResponse, "description": "Listing failed"},
    },
)
async def list_objects(bucket_name: str) -> ListResponse:
    """List all objects in a bucket.

    **Request Example:**
    ```bash
    curl -X GET "http://localhost:8000/v1/datalake/list/my-bucket"
    ```

    **Success Response (200):**
    ```json
    {
      "files": [
        "documents/2024/report1.pdf",
        "documents/2024/report2.pdf"
      ]
    }
    ```

    **Error Response (404 - Bucket Not Found):**
    ```json
    {
      "error": "bucket_not_found",
      "message": "Bucket does not exist",
      "detail": {
        "bucket_name": "nonexistent-bucket"
      }
    }
    ```

    Args:
        bucket_name: S3 bucket name to list

    Returns:
        ListResponse with object keys

    Raises:
        HTTPException 404: Bucket missing (`bucket_not_found`)
        HTTPException 500: Listing failure (`storage_error`)
    """
````

#### Example: POST Upload Endpoint
````python
@router.post(
    "/{workspace_id}/index/",
    response_model=DocumentIngestionResponse,
    responses={
        400: {"model": BadRequestErrorResponse, "description": "Validation failed"},
        413: {"model": PayloadTooLargeResponse, "description": "File too large"},
        500: {"model": InternalServerErrorResponse, "description": "Processing failed"},
    },
)
async def index_document(
    workspace_id: str,
    uploaded_file: UploadFile = File(...),
) -> DocumentIngestionResponse:
    """Upload and index a single document.

    **Request Example:**
    ```bash
    curl -X POST "http://localhost:8000/v1/default/index/" \
      -H "Authorization: Bearer $API_TOKEN" \
      -F "uploaded_file=@docs/index.md"
    ```

    **Success Response (200):**
    ```json
    {
      "ingestion_id": "550e8400-e29b-41d4-a716-446655440000",
      "message": "Indexed document index.md",
      "document_count": 42,
      "metadata_preview": [...]
    }
    ```

    **Error Response (400 - Validation Failed):**
    ```json
    {
      "error": "validation_failed",
      "message": "File type not supported",
      "detail": {
        "allowed_extensions": [".pdf", ".md", ".txt"]
      }
    }
    ```

    Args:
        workspace_id: Workspace slug
        uploaded_file: File to ingest

    Returns:
        DocumentIngestionResponse with ingestion stats

    Raises:
        HTTPException 400: Validation issues (`validation_failed`, `invalid_format`)
        HTTPException 413: File too large (`file_too_large`)
        HTTPException 500: Processing failures (`processing_failed`, `parse_failed`)
    """
````

### Error Documentation
- Enumerate each `HTTPException` under `Raises` with specific codes and explanations.
- Align error code names with [API Error Codes](api-error-codes.md).
- Include references to `ERROR_CODES_REFERENCE.md` when necessary.

### Checklist
Before submitting an endpoint:

1. [ ] Summary line is concise, verb-based.
2. [ ] Description covers constraints/side effects.
3. [ ] Request example reflects actual usage (headers, payload).
4. [ ] Success response JSON matches schema.
5. [ ] Every error path documented with code/examples.
6. [ ] Args, Returns, Raises sections filled out.
7. [ ] Optional notes (rate limits, batch, privacy) included when relevant.
8. [ ] Links to error code reference where appropriate.

## Workflows / Operations
1. **Plan** – Identify request params, responses, and error surfaces.
2. **Draft docstring** – Populate sections in the template order.
3. **Add examples** – Capture real curl + JSON outputs from local testing.
4. **Cross-check error codes** – Ensure codes exist in [API Error Codes](api-error-codes.md).
5. **Verify rendering** – Run `just docs-serve` (or preview in Streamlit console) to confirm formatting.

## Configuration / Interfaces
- Docstrings live inline with FastAPI router functions (primarily `certus_ask/routers/*`).
- Markdown formatting is rendered via FastAPI’s OpenAPI generator and our MkDocs site.
- Standard response helpers (`certus_ask.core.response_utils`) should be used to keep payloads aligned with [Standard Responses](api-response.md).

## Troubleshooting / Gotchas
- **Missing curl headers** – Always show `Content-Type` and `Authorization` when required.
- **Inaccurate response JSON** – Keep examples synchronized with pydantic models; regenerate by calling the endpoint locally.
- **Stale error codes** – Verify codes exist in `certus_ask/schemas/errors.py` and the [error reference](api-error-codes.md).
- **Large docstrings** – Use fenced code blocks (` ```bash `) and concise prose to retain readability.

## Related Documents
- [Standardized Response Format and Trace IDs](api-response.md)
- [API Error Codes](api-error-codes.md)
- [Metadata Envelopes](metadata-envelopes.md)
- [Logging: Privacy Operations](../logging/privacy-operations.md)
